{% extends 'base.html' %}
{% load static %}

{% block title %}{{ student.full_name }} - –£—Å–ø–µ–≤–∞–µ–º–æ—Å—Ç—å{% endblock %}

{% block content %}
<div>
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="page-title mb-2">
                <i class="bi bi-person-circle text-success me-2"></i>
                {{ student.full_name }}
            </h1>
            <p class="text-muted">
                –ì—Ä—É–ø–ø–∞: {{ group.name }} | 
                –õ–æ–≥–∏–Ω: {{ student.login }} |
                {% if student.user_type == 'elder' %}
                <span class="badge-custom badge-warning">–°—Ç–∞—Ä–æ—Å—Ç–∞</span>
                {% endif %}
            </p>
        </div>
        <a href="{% url 'elder_grades' %}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left me-2"></i>
            –ù–∞–∑–∞–¥
        </a>
    </div>
    
    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div class="stats-grid mb-4">
        <div class="stat-card">
            <div class="stat-icon primary"><i class="bi bi-clock-history"></i></div>
            <div class="stat-content">
                <div class="stat-value">{{ total_hours }}</div>
                <div class="stat-label">–ü—Ä–æ–ø—É—Å–∫–æ–≤ (—á)</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon success"><i class="bi bi-star"></i></div>
            <div class="stat-content">
                <div class="stat-value">{{ remaining_hours }}</div>
                <div class="stat-label">–û—Å—Ç–∞–ª–æ—Å—å —á–∞—Å–æ–≤</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon warning"><i class="bi bi-journal-check"></i></div>
            <div class="stat-content">
                <div class="stat-value">{{ subjects_data|length }}</div>
                <div class="stat-label">–ü—Ä–µ–¥–º–µ—Ç–æ–≤</div>
            </div>
        </div>
    </div>
    
    <!-- –ü—Ä–µ–¥—Å—Ç–æ—è—â–∏–µ –≤—ã—Å—Ç—É–ø–ª–µ–Ω–∏—è -->
    {% if slots %}
    <div class="card-custom mb-4">
        <h3 class="section-title mb-3">
            <i class="bi bi-mic me-2"></i>
            –ü—Ä–µ–¥—Å—Ç–æ—è—â–∏–µ –≤—ã—Å—Ç—É–ø–ª–µ–Ω–∏—è
        </h3>
        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th>–î–µ–Ω—å</th>
                        <th>–î–∞—Ç–∞</th>
                        <th>–ü—Ä–µ–¥–º–µ—Ç</th>
                        <th>–í—Ä–µ–º—è</th>
                        <th>–°–ª–æ—Ç</th>
                    </tr>
                </thead>
                <tbody>
                    {% for slot in slots %}
                    <tr>
                        <td>{{ slot.schedule.get_day_display }}</td>
                        <td>{{ slot.schedule.date|date:"d.m.Y" }}</td>
                        <td>{{ slot.schedule.subject }}</td>
                        <td>{{ slot.schedule.start_time }} - {{ slot.schedule.end_time }}</td>
                        <td>–°–ª–æ—Ç {{ slot.slot_number }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}
    <!-- –£—Å–ø–µ–≤–∞–µ–º–æ—Å—Ç—å –ø–æ –ø—Ä–µ–¥–º–µ—Ç–∞–º -->
<div class="card-custom">
    <h3 class="section-title mb-3 d-flex justify-content-between align-items-center">
        <span>
            <i class="bi bi-journal-check me-2"></i>
            –£—Å–ø–µ–≤–∞–µ–º–æ—Å—Ç—å –ø–æ –ø—Ä–µ–¥–º–µ—Ç–∞–º
        </span>
        <button class="btn btn-sm btn-success" onclick="openGradeModal(null, null)">
            <i class="bi bi-plus-circle me-1"></i>
            –î–æ–±–∞–≤–∏—Ç—å –æ—Ü–µ–Ω–∫—É
        </button>
    </h3>
    
    {% for subject_data in subjects_data %}
    <div class="border-bottom pb-3 mb-3">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <div>
                <h4 class="h6 fw-bold mb-0">{{ subject_data.subject.name }}</h4>
                <small class="text-muted">{{ subject_data.subject.teacher|default:"" }}</small>
            </div>
            <div class="d-flex align-items-center gap-2">
                <span class="badge-custom 
                    {% if subject_data.status == 'success' %}badge-success
                    {% elif subject_data.status == 'warning' %}badge-warning
                    {% else %}badge-danger{% endif %}">
                    {{ subject_data.total_points|floatformat:1 }}/21
                </span>
                <button class="btn btn-sm btn-outline-success" 
                        onclick="openGradeModal({{ subject_data.subject.id }}, '{{ subject_data.subject.name }}')">
                    <i class="bi bi-plus-circle"></i>
                </button>
            </div>
        </div>
        
        <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä -->
        <div class="progress-custom mb-2">
            <div class="progress-fill" style="width: {{ subject_data.progress }}%;"></div>
        </div>
        
        <!-- –°–ø–∏—Å–æ–∫ –æ—Ü–µ–Ω–æ–∫ -->
        {% if subject_data.grades %}
        <div class="d-flex flex-wrap gap-2 mt-2">
            {% for grade in subject_data.grades %}
            <div class="position-relative">
                <span class="badge bg-light text-dark p-2" title="{{ grade.date|date:'d.m.Y' }} - {{ grade.comment|default:'' }}">
                    {{ grade.raw_value }}
                    {% if grade.comment %}
                    <i class="bi bi-chat-dots text-muted ms-1" style="font-size: 10px;"></i>
                    {% endif %}
                </span>
                <button class="btn btn-sm btn-link text-danger p-0 position-absolute top-0 start-100 translate-middle" 
                        onclick="deleteGrade({{ grade.id }})" style="font-size: 10px;">
                    <i class="bi bi-x-circle"></i>
                </button>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p class="text-muted small mb-0">–ù–µ—Ç –æ—Ü–µ–Ω–æ–∫</p>
        {% endif %}
    </div>
    {% empty %}
    <p class="text-center text-muted py-4">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ–± —É—Å–ø–µ–≤–∞–µ–º–æ—Å—Ç–∏</p>
    {% endfor %}
</div>
    
    <!-- –î–æ–±–∞–≤—å—Ç–µ —ç—Ç—É —Ñ–æ—Ä–º—É –≤–Ω–∏–∑—É —Å—Ç—Ä–∞–Ω–∏—Ü—ã, –ø–µ—Ä–µ–¥ —Å–∫—Ä–∏–ø—Ç–∞–º–∏ -->
<div class="modal fade" id="gradeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="bi bi-plus-circle me-2"></i>
                    –î–æ–±–∞–≤–∏—Ç—å –æ—Ü–µ–Ω–∫—É
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="gradeForm">
                {% csrf_token %}
                <input type="hidden" name="student_id" value="{{ student.id }}">
                <input type="hidden" name="subject_id" id="gradeSubjectId" value="">  <!-- –í–ê–ñ–ù–û! -->
                <input type="hidden" name="use_today" id="useToday" value="true">
                
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label fw-semibold">–ü—Ä–µ–¥–º–µ—Ç</label>
                        <select class="form-select" id="subjectSelect" required onchange="updateSubjectId(this)">
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç</option>
                            {% for subject_data in subjects_data %}
                            <option value="{{ subject_data.subject.id }}" data-name="{{ subject_data.subject.name }}">
                                {{ subject_data.subject.name }} ({{ subject_data.total_points }}/21)
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-semibold">–¢–∏–ø –æ—Ü–µ–Ω–∫–∏</label>
                        <div class="d-flex flex-wrap gap-2 mb-2">
                            <button type="button" class="btn btn-outline-success grade-type-btn" data-type="performance" data-value="–≤—ã—Å—Ç—É–ø–ª–µ–Ω–∏–µ">üé§ –≤—ã—Å—Ç—É–ø–ª–µ–Ω–∏–µ</button>
                            <button type="button" class="btn btn-outline-success grade-type-btn" data-type="supplement" data-value="–¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ">üìù –¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ</button>
                            <button type="button" class="btn btn-outline-success grade-type-btn" data-type="question" data-value="–≤–æ–ø—Ä–æ—Å">‚ùì –≤–æ–ø—Ä–æ—Å</button>
                        </div>
                        <div class="d-flex flex-wrap gap-2">
                            <button type="button" class="btn btn-outline-success grade-type-btn" data-type="plus" data-value="+">‚ûï</button>
                            <button type="button" class="btn btn-outline-success grade-type-btn" data-type="minus" data-value="-">‚ûñ</button>
                            <button type="button" class="btn btn-outline-success grade-type-btn" data-type="numeric_2" data-value="2">2</button>
                            <button type="button" class="btn btn-outline-success grade-type-btn" data-type="numeric_3" data-value="3">3</button>
                            <button type="button" class="btn btn-outline-success grade-type-btn" data-type="numeric_4" data-value="4">4</button>
                            <button type="button" class="btn btn-outline-success grade-type-btn" data-type="numeric_5" data-value="5">5</button>
                        </div>
                        <input type="hidden" name="grade_type" id="gradeType" required>
                        <input type="hidden" name="raw_value" id="rawValue" required>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-semibold">–î–∞—Ç–∞</label>
                        <input type="date" class="form-control" name="date" id="gradeDate" value="{{ today|date:'Y-m-d' }}" required>
                        <div class="form-check mt-2">
                            <input type="checkbox" class="form-check-input" id="isToday" checked onchange="toggleDateField()">
                            <label class="form-check-label" for="isToday">–°–µ–≥–æ–¥–Ω—è</label>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-semibold">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
                        <textarea class="form-control" name="comment" rows="2" placeholder="–ù–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn btn-success">–î–æ–±–∞–≤–∏—Ç—å –æ—Ü–µ–Ω–∫—É</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –æ—Ü–µ–Ω–∫–∞–º–∏
function updateSubjectId(select) {
    document.getElementById('gradeSubjectId').value = select.value;
}

function toggleDateField() {
    const isToday = document.getElementById('isToday').checked;
    const dateField = document.getElementById('gradeDate');
    const useToday = document.getElementById('useToday');
    
    if (isToday) {
        dateField.disabled = true;
        useToday.value = 'true';
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ–≥–æ–¥–Ω—è—à–Ω—é—é –¥–∞—Ç—É
        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const day = String(today.getDate()).padStart(2, '0');
        dateField.value = `${year}-${month}-${day}`;
    } else {
        dateField.disabled = false;
        useToday.value = 'false';
    }
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ —Ç–∏–ø–æ–≤ –æ—Ü–µ–Ω–æ–∫
document.querySelectorAll('.grade-type-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        document.getElementById('gradeType').value = this.dataset.type;
        document.getElementById('rawValue').value = this.dataset.value;
        
        document.querySelectorAll('.grade-type-btn').forEach(b => {
            b.classList.remove('active', 'btn-success');
            b.classList.add('btn-outline-success');
        });
        this.classList.remove('btn-outline-success');
        this.classList.add('active', 'btn-success');
    });
});

// –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã
document.getElementById('gradeForm')?.addEventListener('submit', function(e) {
    e.preventDefault();
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤—ã–±—Ä–∞–Ω –ª–∏ –ø—Ä–µ–¥–º–µ—Ç
    if (!document.getElementById('gradeSubjectId').value) {
        showNotification('‚ùå –í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç', 'danger');
        return;
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤—ã–±—Ä–∞–Ω –ª–∏ —Ç–∏–ø –æ—Ü–µ–Ω–∫–∏
    if (!document.getElementById('gradeType').value) {
        showNotification('‚ùå –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –æ—Ü–µ–Ω–∫–∏', 'danger');
        return;
    }
    
    const formData = new FormData(this);
    const data = Object.fromEntries(formData.entries());
    
    fetch('/elders/api/add-grade/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('gradeModal')).hide();
            showNotification('‚úÖ –û—Ü–µ–Ω–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞');
            setTimeout(() => location.reload(), 1000);
        } else {
            showNotification('‚ùå –û—à–∏–±–∫–∞: ' + data.error, 'danger');
        }
    })
    .catch(error => {
        showNotification('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏', 'danger');
    });
});

function showNotification(message, type = 'success') {
    const notification = document.createElement('div');
    notification.className = `alert alert-${type} position-fixed top-0 end-0 m-3`;
    notification.style.zIndex = '9999';
    notification.innerHTML = message;
    document.body.appendChild(notification);
    setTimeout(() => notification.remove(), 3000);
}

function openGradeModal(subjectId, subjectName) {
    document.getElementById('gradeSubjectId').value = subjectId;
    
    // –í—ã–±–∏—Ä–∞–µ–º –Ω—É–∂–Ω—ã–π –ø—Ä–µ–¥–º–µ—Ç –≤ —Å–µ–ª–µ–∫—Ç–µ
    const select = document.getElementById('subjectSelect');
    for (let option of select.options) {
        if (option.value == subjectId) {
            option.selected = true;
            break;
        }
    }
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ç–∏–ø –æ—Ü–µ–Ω–∫–∏
    document.getElementById('gradeType').value = '';
    document.getElementById('rawValue').value = '';
    document.querySelectorAll('.grade-type-btn').forEach(b => {
        b.classList.remove('active', 'btn-success');
        b.classList.add('btn-outline-success');
    });
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ–≥–æ–¥–Ω—è—à–Ω—é—é –¥–∞—Ç—É
    document.getElementById('isToday').checked = true;
    toggleDateField();
    
    new bootstrap.Modal(document.getElementById('gradeModal')).show();
}


function deleteGrade(gradeId) {
    if (confirm('–£–¥–∞–ª–∏—Ç—å –æ—Ü–µ–Ω–∫—É?')) {
        fetch('/elders/api/delete-grade/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ id: gradeId })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('‚úÖ –û—Ü–µ–Ω–∫–∞ —É–¥–∞–ª–µ–Ω–∞');
                setTimeout(() => location.reload(), 1000);
            } else {
                showNotification('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏', 'danger');
            }
        });
    }
}

</script>

<style>
.grade-type-btn.active {
    background-color: #28a745 !important;
    color: white !important;
}

.grade-type-btn {
    transition: all 0.2s;
}


</style>

    <!-- –ò—Å—Ç–æ—Ä–∏—è –ø—Ä–æ–ø—É—Å–∫–æ–≤ -->
    {% if attendances %}
    <div class="card-custom mt-4">
        <h3 class="section-title mb-3">
            <i class="bi bi-calendar-x me-2"></i>
            –ò—Å—Ç–æ—Ä–∏—è –ø—Ä–æ–ø—É—Å–∫–æ–≤
        </h3>
        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th>–î–∞—Ç–∞</th>
                        <th>–ß–∞—Å—ã</th>
                        <th>–ü—Ä–∏—á–∏–Ω–∞</th>
                        <th>–ö—Ç–æ –æ—Ç–º–µ—Ç–∏–ª</th>
                    </tr>
                </thead>
                <tbody>
                    {% for attendance in attendances %}
                    <tr>
                        <td>{{ attendance.date|date:"d.m.Y" }}</td>
                        <td><span class="badge-custom badge-danger">{{ attendance.hours }} —á</span></td>
                        <td>{{ attendance.reason|default:"‚Äî" }}</td>
                        <td>{{ attendance.marked_by.full_name|default:"–°–∏—Å—Ç–µ–º–∞" }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}