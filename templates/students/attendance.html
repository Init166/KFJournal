{% extends 'base.html' %}
{% load static %}

{% block title %}История пропусков{% endblock %}

{% block content %}
<div>
    <!-- Заголовок -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="page-title">
            <i class="bi bi-calendar-x text-danger me-2"></i>
            История пропусков
        </h1>
        <a href="{% url 'student_dashboard' %}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i>
        </a>
    </div>
    
    <!-- Статистика -->
    <div class="stats-grid mb-4">
        <div class="stat-card">
            <div class="stat-icon danger"><i class="bi bi-clock-history"></i></div>
            <div class="stat-content">
                <div class="stat-value">{{ total_hours }}</div>
                <div class="stat-label">Всего часов</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon warning"><i class="bi bi-hourglass-split"></i></div>
            <div class="stat-content">
                <div class="stat-value">{{ remaining }}</div>
                <div class="stat-label">Осталось</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon success"><i class="bi bi-list-check"></i></div>
            <div class="stat-content">
                <div class="stat-value">{{ history|length }}</div>
                <div class="stat-label">Записей</div>
            </div>
        </div>
    </div>
    
    <!-- Прогресс-бар -->
    <div class="card-custom mb-4">
        <h3 class="section-title">Лимит пропусков</h3>
        <div class="progress-custom mb-2" style="height: 20px;">
            <div class="progress-fill {% if progress >= 75 %}bg-danger{% elif progress >= 50 %}bg-warning{% endif %}" 
                 style="width: {{ progress }}%;"></div>
        </div>
        <div class="d-flex justify-content-between">
            <span>Использовано: {{ total_hours }} ч</span>
            <span>Осталось: {{ remaining }} ч</span>
        </div>
    </div>
    
    <!-- История -->
    <div class="card-custom">
        <h3 class="section-title">
            <i class="bi bi-clock-history me-2 text-info"></i>
            Детальная история
        </h3>
        
        {% if history %}
            <div class="vstack gap-2">
                {% for item in history %}
                <div class="d-flex flex-column flex-sm-row justify-content-between align-items-sm-center p-3 bg-light rounded">
                    <div class="mb-2 mb-sm-0">
                        <i class="bi bi-calendar me-2"></i>
                        {{ item.date|date:"d.m.Y" }}
                        {% if item.date|date:"l" == "воскресенье" %}
                        <span class="badge-custom badge-danger ms-2">Вс</span>
                        {% endif %}
                    </div>
                    <div class="d-flex align-items-center gap-3">
                        <span class="badge-custom badge-danger">{{ item.hours }} ч.</span>
                        <span class="text-muted">{{ item.reason|default:"—" }}</span>
                        <small class="text-muted">
                            <i class="bi bi-person"></i> {{ item.marked_by.full_name|default:"Система" }}
                        </small>
                    </div>
                </div>
                {% endfor %}
            </div>
            
            <!-- Сводка по месяцам -->
            {% if months %}
            <div class="mt-4">
                <h4 class="h6 fw-bold mb-3">Статистика по месяцам</h4>
                <div class="row g-2">
                    {% for month, hours in months.items %}
                    <div class="col-6 col-md-4">
                        <div class="p-2 bg-light rounded text-center">
                            <div>{{ month|date:"F Y" }}</div>
                            <span class="badge-custom badge-danger">{{ hours }} ч</span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            
        {% else %}
            <div class="text-center py-5">
                <i class="bi bi-check-circle-fill text-success display-1"></i>
                <h5 class="mt-3">У вас нет пропусков!</h5>
                <p class="text-muted">Так держать! Продолжайте посещать все занятия</p>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}